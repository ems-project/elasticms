{% extends '@EMSCore/components/json_menu_nested/template.twig' %}

{%- block jmn_title -%}
    <h2 class="h4">{{ sectionLabel }}</h2>
{%- endblock -%}

{%- block jmn_menu_add -%}
    <ul class="dropdown-menu pull-right">
        {% for addNode in addNodes %}
            <li>{{ template.block('jmn_button_item_add', _context)|raw }}</li>
        {% endfor %}
        <li>
            <button class="ems-add-existing-page" data-modal-size="md">
                <i class="fa fa-sign-in"></i>
                Existing content
            </button>
        </li>
    </ul>
{%- endblock jmn_menu_add -%}

{%- block jmn_cell_title -%}
    {% if item.hasChildren %}
        <button class="jmn-item-icon jmn-btn-collapse" aria-expanded="{{- item in loadParents ? 'true' : 'false' -}}"></button>
    {% endif %}
    {% if node.icon %}
        <div class="jmn-item-icon"><i class="{{ node.icon }}"></i></div>
    {% endif %}

    {% if attribute(item.object, locale)|default(false) and attribute(item.object, locale).title|default(false) %}
        <span>{{ attribute(item.object, locale).title }}</span>
    {% else %}
        <span class="text-gray">{{ item.label }}</span>
    {% endif %}
{%- endblock jmn_cell_title -%}

{% block jmn_column_content %}Content{% endblock %}

{% block jmn_cell_content %}
    {% set content = emsch_search(config.context.contentTypes, {
        "query": {
            "terms": {"menu": [item.id]}
        },
        "size": 2,
    }).hits.hits %}
    {% if content|length == 0 %}
        <div class="btn-group">
            <button data-id="{{ item.id }}" class="json-post-button btn btn-sm btn-warning new-button" data-object="{{ item.object|json_encode|e('html_attr') }}" data-type="{{ item.type|e('html_attr') }}" data-label="{{ item.label|e('html_attr') }}" id="new-btn-{{ item.id|e('html_attr') }}">
                <i class="fa fa-plus"></i>
                New {{ item.type }}
            </button>
            <button class="btn btn-sm btn-warning attach-content" data-item-id="{{ item.id }}" data-item-type="{{ item.type }}">
                <i class="fa fa-sign-in"></i>
                Existing content
            </button>
        </div>
    {% elseif content|length == 1 %}
        {% set info = "#{content.0._source._contenttype}:#{content.0._id}"|emsco_document_info %}
        {% set contentType = content.0._source._contenttype|get_content_type %}
        {% set ouuid = content.0._id %}
        {% set environment = 'preview'|get_environment %}
        <div class="btn-toolbar" role="toolbar" style="margin: 0;">
            <div class="btn-group">
                {% include '@EMSCore/elements/object-views-button.html.twig' with {
                    ouuid:  ouuid,
                    contentType: contentType,
                    environment: environment,
                    recursiveView: false,
                    object: content.0,
                }%}
                {% if info and  is_granted(contentType.roles.edit) %}
                    {% if not  contentType.circlesField or attribute(source, contentType.circlesField) is not defined or attribute(source, contentType.circlesField)|in_my_circles %}
                        {% include '@EMSCore/elements/post-button.html.twig' with {
                            'url': path('revision.new-draft', {'ouuid': ouuid, 'type': contentType.name}),
                            'label': 'Edit',
                            'icon': 'pencil' }%}
                    {% endif %}
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="col-xs-12 text-center">
            Error: multiple pages are attached to this item
        </div>
    {% endif %}
{% endblock %}

{% block jmn_column_status %}
    <div>
        <div class="col-xs-12">Publication status</div>
        {% for env in config.context.environments %}
            <div style="width: 80px;float: left">{{ env|get_environment.label }}</div>
        {% endfor %}
    </div>
{% endblock %}

{% block jmn_cell_status %}
    {% set content = emsch_search(config.context.contentTypes, {
        "query": { "terms": {"menu": [item.id]} },
        "size": 2,
        "_source": ['label']
    }).hits.hits %}
    {% if content|length == 1 %}
        {% set info = "#{content.0._source._contenttype}:#{content.0._id}"|emsco_document_info %}
        {% for env in config.context.environments %}
            {% if info.defaultEnvironment.name == env %}
                {% if info.hasDraft %}
                    <span class="jmn-badge label label-warning col-sm-12">Draft</span>
                {% else %}
                    <span class="jmn-badge label label-success col-sm-12">Published</span>
                {% endif %}
            {% else %}
                {% if info.aligned(env) %}
                    <span class="jmn-badge label label-success col-sm-12">Published</span>
                {% elseif info.published(env) %}
                    <span class="jmn-badge label label-warning col-sm-12">Outdated</span>
                {% else %}
                    <span class="jmn-badge label label-default col-sm-12">Unavailable</span>
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endblock %}